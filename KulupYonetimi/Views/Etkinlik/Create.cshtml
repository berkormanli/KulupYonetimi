@model KulupYonetimi.Models.ViewModels.EtkinlikCreateViewModel

@{ 
    ViewData["Title"] = "Yeni Etkinlik Oluştur";
}

<div class="container">
    <h1 class="my-4">@ViewData["Title"]</h1>

    <div class="row">
        <div class="col-md-8">
            <form asp-action="Create">
                <div asp-validation-summary="All" class="text-danger"></div>
                
                <div class="mb-3">
                    <label asp-for="Ad" class="form-label"></label>
                    <input asp-for="Ad" class="form-control" />
                </div>

                <div class="mb-3">
                    <label asp-for="Aciklama" class="form-label"></label>
                    <textarea asp-for="Aciklama" class="form-control" rows="3"></textarea>
                </div>

                <div class="row">
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label asp-for="EtkinlikGunu" class="form-label">Tarih</label>
                            <input asp-for="EtkinlikGunu" class="form-control" type="date" min="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label asp-for="EtkinlikSaati" class="form-label">Saat</label>
                            <select asp-for="EtkinlikSaati" asp-items='new SelectList(ViewBag.Times)' class="form-control"></select>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label asp-for="Konum" class="form-label"></label>
                            <input asp-for="Konum" class="form-control" />
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 d-md-flex justify-content-md-start">
                    <button type="submit" class="btn btn-primary">Oluştur</button>
                    <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">Geri Dön</a>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        (function () {
            const dateInput = document.querySelector('input[name="EtkinlikGunu"]');
            const timeSelect = document.querySelector('select[name="EtkinlikSaati"]');
            const submitButton = document.querySelector('button[type="submit"]');

            if (!dateInput || !timeSelect) return;

            const allTimes = Array.from(timeSelect.options).map(opt => ({ value: opt.value, text: opt.text }));

            const setMinToday = () => {
                const todayStr = new Date().toISOString().split('T')[0];
                dateInput.min = todayStr;

                if (dateInput.value && dateInput.value < todayStr) {
                    dateInput.value = todayStr;
                }
            };

            const toMinutes = (time) => {
                const [hour, minute] = time.split(':').map(Number);
                return hour * 60 + minute;
            };

            const rebuildOptions = (filteredOptions) => {
                const currentSelection = timeSelect.value;
                timeSelect.innerHTML = '';

                if (!filteredOptions.length) {
                    const option = document.createElement('option');
                    option.textContent = 'Bugün için uygun saat yok';
                    option.disabled = true;
                    option.selected = true;
                    timeSelect.appendChild(option);
                    if (submitButton) submitButton.disabled = true;
                    return;
                }

                if (submitButton) submitButton.disabled = false;

                filteredOptions.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt.value;
                    option.textContent = opt.text;
                    timeSelect.appendChild(option);
                });

                const availableSelection = filteredOptions.some(opt => opt.value === currentSelection)
                    ? currentSelection
                    : filteredOptions[0].value;

                timeSelect.value = availableSelection;
            };

            const filterTimesForDate = () => {
                const selectedDate = dateInput.value ? new Date(dateInput.value) : null;
                const today = new Date();
                let filtered = allTimes;

                if (selectedDate) {
                    selectedDate.setHours(0, 0, 0, 0);
                    const todayStart = new Date(today.getFullYear(), today.getMonth(), today.getDate());

                    if (selectedDate.getTime() === todayStart.getTime()) {
                        const nowMinutes = today.getHours() * 60 + today.getMinutes();
                        filtered = allTimes.filter(opt => toMinutes(opt.value) >= nowMinutes);
                    }
                }

                rebuildOptions(filtered);
            };

            const handleDateChange = () => {
                setMinToday();
                filterTimesForDate();
            };

            dateInput.addEventListener('change', handleDateChange);
            dateInput.addEventListener('input', handleDateChange);
            handleDateChange();
        })();
    </script>
}
